{% extends 'vms_base.html' %} {% macro report_content() %}
<div class="container py-4">
  <div class="d-flex align-items-center mb-3 flex-wrap">
    <div class="me-3">
      <h1 class="h3 mb-0">Visitor Report</h1>
    </div>
  </div>

  <div
    class="d-flex justify-content-end gap-2 align-items-center mb-3 flex-wrap"
  >
    <input
      type="text"
      id="range"
      class="form-control"
      placeholder="Select date range"
      style="max-width: 280px"
    />
    <select id="vtype" class="form-select" style="max-width: 160px">
      <option value="all">All Types</option>
      <option value="visitor">Visitor</option>
      <option value="contractor">Contractor</option>
      <option value="employee">Employee</option>
    </select>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="pending" />
      <label class="form-check-label" for="pending">Include Pending</label>
    </div>
    <button id="loadReport" class="btn btn-primary">
      <span
        class="spinner-border spinner-border-sm d-none"
        id="loadSpinner"
        role="status"
        aria-hidden="true"
      ></span>
      <span>Load Report</span>
    </button>
    <button id="exportCsv" class="btn btn-outline-secondary">
      <i class="bi bi-download"></i> Export CSV
    </button>
    <button id="clearFilters" class="btn btn-link">Clear</button>
  </div>

  <ul class="nav nav-pills mb-3" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="pass-tab"
        data-bs-toggle="pill"
        data-bs-target="#passPane"
        type="button"
        role="tab"
      >
        All Passes
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="visitor-tab"
        data-bs-toggle="pill"
        data-bs-target="#visitorPane"
        type="button"
        role="tab"
      >
        Visitor-wise
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="host-tab"
        data-bs-toggle="pill"
        data-bs-target="#hostPane"
        type="button"
        role="tab"
      >
        Host-wise
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="passPane" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped" id="passTable">
          <thead class="table-light sticky-top">
            <tr>
              <th>Gate ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Host</th>
              <th>Type</th>
              <th>Purpose</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center my-2">
        <div>
          <label for="passRows" class="form-label me-2 mb-0"
            >Rows per page</label
          >
          <select id="passRows" class="form-select d-inline-block w-auto">
            <option>10</option>
            <option>25</option>
            <option>50</option>
            <option>100</option>
          </select>
        </div>
        <div>
          <button class="btn btn-outline-secondary btn-sm me-2" id="passPrev">
            Prev
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="passNext">
            Next
          </button>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="visitorPane" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped" id="visitorTable">
          <thead class="table-light sticky-top">
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Visits</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center my-2">
        <div>
          <label for="visitorRows" class="form-label me-2 mb-0"
            >Rows per page</label
          >
          <select id="visitorRows" class="form-select d-inline-block w-auto">
            <option>10</option>
            <option>25</option>
            <option>50</option>
            <option>100</option>
          </select>
        </div>
        <div>
          <button
            class="btn btn-outline-secondary btn-sm me-2"
            id="visitorPrev"
          >
            Prev
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="visitorNext">
            Next
          </button>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="hostPane" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-striped" id="hostTable">
          <thead class="table-light sticky-top">
            <tr>
              <th>Host</th>
              <th>Visitors Met</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center my-2">
        <div>
          <label for="hostRows" class="form-label me-2 mb-0"
            >Rows per page</label
          >
          <select id="hostRows" class="form-select d-inline-block w-auto">
            <option>10</option>
            <option>25</option>
            <option>50</option>
            <option>100</option>
          </select>
        </div>
        <div>
          <button class="btn btn-outline-secondary btn-sm me-2" id="hostPrev">
            Prev
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="hostNext">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endmacro %} {% block title %}Visitor Report{% endblock %} {% block extra_head
%}
<link href="/static/css/flatpickr.min.css" rel="stylesheet" />
<script src="/static/js/flatpickr.min.js"></script>
<style>
  .flatpickr-calendar {
    z-index: 10000 !important;
  }
</style>
{% endblock %} {% block content %} {{ report_content() }} {% endblock %} {%
block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let picker;
  let rawData = [],
    visitorData = [],
    hostData = [];
  const passPag = { page: 1, size: 10 };
  const visitorPag = { page: 1, size: 10 };
  const hostPag = { page: 1, size: 10 };

  function groupData() {
    const vMap = new Map();
    const hMap = {};
    for (const v of rawData) {
      const key = `${v.name || ""}|${v.phone || ""}`;
      const existing = vMap.get(key) || {
        name: v.name || "Unknown",
        phone: v.phone || "",
        count: 0,
      };
      existing.count++;
      vMap.set(key, existing);
      if (v.host) {
        hMap[v.host] = hMap[v.host] || new Set();
        hMap[v.host].add(key);
      }
    }
    visitorData = Array.from(vMap.values());
    hostData = Object.entries(hMap).map(([host, set]) => ({
      host,
      count: set.size,
    }));
  }

  function renderPassTable() {
    const tbody = document.querySelector("#passTable tbody");
    const start = (passPag.page - 1) * passPag.size;
    const rows = rawData.slice(start, start + passPag.size);
    tbody.innerHTML = "";
    if (rows.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="7" class="text-center py-5 text-muted">No records match your filters.</td></tr>';
    } else {
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.gate_id || ""}</td><td>${r.name || ""}</td><td>${r.phone || ""}</td><td>${r.host || ""}</td><td>${r.visitor_type || ""}</td><td>${r.purpose || ""}</td><td>${r.time || ""}</td>`;
        tbody.appendChild(tr);
      }
      document.getElementById("passPrev").disabled = passPag.page <= 1;
      document.getElementById("passNext").disabled =
        passPag.page >= Math.ceil(rawData.length / passPag.size);
    }
    document.getElementById("passPrev").disabled = passPag.page <= 1;
    document.getElementById("passNext").disabled =
      passPag.page >= Math.ceil(rawData.length / passPag.size);
    const pagDiv = document.getElementById("passRows").closest(".d-flex");
    if (rawData.length <= passPag.size) {
      pagDiv.classList.add("d-none");
    } else {
      pagDiv.classList.remove("d-none");
    }
  }

  function renderVisitorTable() {
    const tbody = document.querySelector("#visitorTable tbody");
    const start = (visitorPag.page - 1) * visitorPag.size;
    const rows = visitorData.slice(start, start + visitorPag.size);
    tbody.innerHTML = "";
    if (rows.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="3" class="text-center py-5 text-muted">No records match your filters.</td></tr>';
    } else {
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.name}</td><td>${r.phone}</td><td>${r.count}</td>`;
        tbody.appendChild(tr);
      }
      document.getElementById("visitorPrev").disabled = visitorPag.page <= 1;
      document.getElementById("visitorNext").disabled =
        visitorPag.page >= Math.ceil(visitorData.length / visitorPag.size);
    }
    document.getElementById("visitorPrev").disabled = visitorPag.page <= 1;
    document.getElementById("visitorNext").disabled =
      visitorPag.page >= Math.ceil(visitorData.length / visitorPag.size);
    const pagDiv = document.getElementById("visitorRows").closest(".d-flex");
    if (visitorData.length <= visitorPag.size) {
      pagDiv.classList.add("d-none");
    } else {
      pagDiv.classList.remove("d-none");
    }
  }

  function renderHostTable() {
    const tbody = document.querySelector("#hostTable tbody");
    const start = (hostPag.page - 1) * hostPag.size;
    const rows = hostData.slice(start, start + hostPag.size);
    tbody.innerHTML = "";
    if (rows.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="2" class="text-center py-5 text-muted">No records match your filters.</td></tr>';
    } else {
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.host}</td><td>${r.count}</td>`;
        tbody.appendChild(tr);
      }
      document.getElementById("hostPrev").disabled = hostPag.page <= 1;
      document.getElementById("hostNext").disabled =
        hostPag.page >= Math.ceil(hostData.length / hostPag.size);
    }
    document.getElementById("hostPrev").disabled = hostPag.page <= 1;
    document.getElementById("hostNext").disabled =
      hostPag.page >= Math.ceil(hostData.length / hostPag.size);
    const pagDiv = document.getElementById("hostRows").closest(".d-flex");
    if (hostData.length <= hostPag.size) {
      pagDiv.classList.add("d-none");
    } else {
      pagDiv.classList.remove("d-none");
    }
  }

  function getReportParams() {
    const [startDate, endDate] = picker.selectedDates;
    if (!startDate || !endDate) {
      alert("Select date range");
      return null;
    }
    const params = new URLSearchParams();
    const s = new Date(startDate);
    const e = new Date(endDate);
    s.setHours(0, 0, 0, 0);
    e.setHours(23, 59, 59, 999);
    params.append("start_date", s.toISOString().split("T")[0]);
    params.append("end_date", e.toISOString().split("T")[0]);
    const vtype = document.getElementById("vtype").value || "all";
    params.append("type", vtype);
    const pending = document.getElementById("pending").checked;
    params.append("include_pending", pending ? "1" : "0");
    return { params };
  }

  async function loadReport() {
    const p = getReportParams();
    if (!p) {
      return;
    }
    document.getElementById("loadSpinner").classList.remove("d-none");
    document.getElementById("loadReport").disabled = true;
    try {
      const resp = await fetch("/api/visitor-report?" + p.params.toString());
      if (!resp.ok) {
        throw new Error("Failed to load");
      }
      const data = await resp.json();
      rawData = data.items || [];
      groupData();
      passPag.page = 1;
      visitorPag.page = 1;
      hostPag.page = 1;
      renderPassTable();
      renderVisitorTable();
      renderHostTable();
    } catch (err) {
      alert("Failed to load report");
    } finally {
      document.getElementById("loadSpinner").classList.add("d-none");
      document.getElementById("loadReport").disabled = false;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    picker = flatpickr("#range", { mode: "range", dateFormat: "Y-m-d" });
    function setLast7() {
      const now = new Date();
      const start = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate() - 6,
      );
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      picker.setDate([start, end], true);
    }

    const resetBtn = document.getElementById("resetRange");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        setLast7();
      });
    }
    document.getElementById("loadReport").addEventListener("click", loadReport);
    document.getElementById("exportCsv").addEventListener("click", () => {
      const p = getReportParams();
      if (!p) return;
      p.params.append("view", "pass");
      p.params.append("fmt", "csv");
      window.location = "/api/visitor-report/export?" + p.params.toString();
    });

    document.getElementById("passRows").addEventListener("change", (e) => {
      passPag.size = parseInt(e.target.value);
      passPag.page = 1;
      renderPassTable();
    });
    document.getElementById("visitorRows").addEventListener("change", (e) => {
      visitorPag.size = parseInt(e.target.value);
      visitorPag.page = 1;
      renderVisitorTable();
    });
    document.getElementById("hostRows").addEventListener("change", (e) => {
      hostPag.size = parseInt(e.target.value);
      hostPag.page = 1;
      renderHostTable();
    });

    document.getElementById("passPrev").addEventListener("click", () => {
      if (passPag.page > 1) {
        passPag.page--;
        renderPassTable();
      }
    });
    document.getElementById("passNext").addEventListener("click", () => {
      if (passPag.page < Math.ceil(rawData.length / passPag.size)) {
        passPag.page++;
        renderPassTable();
      }
    });

    document.getElementById("clearFilters").addEventListener("click", () => {
      picker.clear();
      document.getElementById("vtype").value = "all";
      document.getElementById("pending").checked = false;
      rawData = [];
      visitorData = [];
      hostData = [];
      renderPassTable();
      renderVisitorTable();
      renderHostTable();
      document.getElementById("activeRange").classList.add("d-none");
    });

    setLast7();
  });
</script>
{% endblock %}
