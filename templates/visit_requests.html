{% extends 'vms_base.html' %}
{% block title %}Visit Requests{% endblock %}
{% block content %}
  <div class="container my-4">
    <h1 class="mb-4">Visit Requests</h1>
    <div class="card">
      <div class="card-body">
        {% if rows %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead><tr><th>ID</th><th>Photo</th><th>Name</th><th>Phone</th><th>Host</th><th>Host Email</th><th>Status</th><th>Request Time</th><th>Expiry</th><th>Action</th></tr></thead>
            <tbody>
              {% set color = {'pending':'warning text-dark','approved':'success','rejected':'danger','waiting':'secondary','rescheduled':'info text-dark'} %}
              {% for r in rows %}
              <tr>
                <td>{{ r.id }}</td>
                <td>{% if r.image %}<img src="data:image/jpeg;base64,{{ r.image }}" class="img-thumbnail img-fluid" style="width:2.5rem" alt="photo">{% endif %}</td>
                <td>{{ r.name or '' }}</td>
                <td>{{ r.phone or '' }}</td>
                <td>{{ r.host or '' }}</td>
                <td>{{ r.host_email or '' }}</td>
                <td><span class="badge bg-{{ color.get(r.status,'secondary') }}">{{ r.status }}</span></td>
                <td>{{ r.time or r.invite_time or '' }}</td>
                <td>{{ r.expiry_time or '' }}</td>
                <td>
                  <button class="btn btn-sm btn-success" onclick="act('approve','{{ r.id }}')">Approve</button>
                  <button class="btn btn-sm btn-danger" onclick="act('reject','{{ r.id }}')">Reject</button>
                  <button class="btn btn-sm btn-warning" onclick="act('wait','{{ r.id }}')">Mark Waiting</button>
                  <button class="btn btn-sm btn-secondary" onclick="act('reschedule','{{ r.id }}')">Reschedule</button>
                  <button class="btn btn-sm btn-primary" onclick="approvePass('{{ r.id }}')">Approve &amp; Create Gate Pass</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="mb-0">No pending visit requests.</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_scripts %}
<script>
async function act(op,id){
  let body='id='+id;
  if(op==='reschedule'){
    const t=prompt('Enter new datetime (YYYY-MM-DD HH:MM)');
    if(!t) return;
    body+='&new_time='+encodeURIComponent(t);
  }
  const r=await fetch('/visit_requests/'+op,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
  if(r.ok) location.reload();
}
function approvePass(id){
  fetch('/visit_requests/approve',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'id='+id})
    .then(()=>{window.location='/vms?req_id='+id;});
}
</script>
{% endblock %}
