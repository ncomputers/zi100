<!-- htmlhint spec-char-escape:false, tag-pair:false -->
<!-- Purpose: email alerts template -->
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Alert Rules</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/flatly/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="vms-body">
<!-- ===== Section: Navbar ===== -->
{% include 'partials/header.html' %}
<!-- ===== Section: Main Content ===== -->
<div class="container mt-4">
    <h1 class="mb-4">Email &amp; Alerts</h1>
    <div id="msg"></div>
    <form id="rulesForm">
    <div class="table-responsive">
    <table class="table" id="rulesTable">
        <thead>
        <tr><th>Metric</th><th>Type</th><th>Value</th><th>Recipients</th><th>Attach</th><th></th></tr>
        </thead>
        <tbody>
        {% for r in rules %}
        <tr>
            <td>
                <select class="form-select metric">
                {% for opt in anomaly_items %}
                    <option value="{{opt}}"{% if r.metric == opt %} selected="selected"{% endif %}>{{opt.replace('_',' ').title()}}</option>
                {% endfor %}
                </select>
            </td>
            <td>
                <select class="form-select type">
                    <option value="event"{% if r.type == "event" %} selected="selected"{% endif %}>Event</option>
                    <option value="threshold"{% if r.type == "threshold" %} selected="selected"{% endif %}>Threshold</option>
                    <option value="frequency"{% if r.type == "frequency" %} selected="selected"{% endif %}>Frequency</option>
                </select>
            </td>
            <td><input type="number" class="form-control value" value="{{r.value or 1}}"></td>
            <td><input class="form-control recipients" value="{{r.recipients}}"></td>
            <td class="text-center"><input type="checkbox" class="form-check-input attach" {% if r.attach %}checked{% endif %}></td>
            <td><button class="btn btn-danger btn-sm del" type="button">Delete</button></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
    <input type="hidden" name="csrf_token" value="{{csrf_token}}">
    <button class="btn btn-secondary mb-3" id="addRule" type="button">Add Rule</button>
    <div>
        <button class="btn btn-primary" id="save" type="button">Save</button>
        <a href="/" class="btn btn-outline-secondary ms-2">Back</a>
    </div>
    </form>
</div>
<script>
const metricOptions = `{% for opt in anomaly_items %}<option value="{{opt}}">{{opt.replace('_',' ').title()}}</option>{% endfor %}`;
function rowTemplate() {
    return `<tr>
    <td><select class="form-select metric">${metricOptions}</select></td>
    <td><select class="form-select type"><option value="event">Event</option><option value="threshold">Threshold</option><option value="frequency">Frequency</option></select></td>
    <td><input type="number" class="form-control value" value="1"></td>
    <td><input class="form-control recipients"></td>
    <td class="text-center"><input type="checkbox" class="form-check-input attach"></td>
    <td><button class="btn btn-danger btn-sm del" type="button">Delete</button></td>
</tr>`;
}

document.getElementById('addRule').onclick=function(){
    document.querySelector('#rulesTable tbody').insertAdjacentHTML('beforeend', rowTemplate());
};

document.querySelector('#rulesTable').addEventListener('click',e=>{
    if(e.target.classList.contains('del')) e.target.closest('tr').remove();
});

  document.getElementById('save').onclick=async ()=>{
      const rows=document.querySelectorAll('#rulesTable tbody tr');
      const rules=[];
      rows.forEach(r=>{
          rules.push({
              metric:r.querySelector('.metric').value,
              type:r.querySelector('.type').value,
              value:parseInt(r.querySelector('.value').value||0),
              recipients:r.querySelector('.recipients').value,
              attach:r.querySelector('.attach').checked
          });
      });
      const token=document.querySelector('#rulesForm input[name="csrf_token"]').value;
      const r=await fetch('/alerts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rules,csrf_token:token})});
      const d=await r.json();
      document.getElementById('msg').innerHTML=d.saved?'<div class="alert alert-success">Saved</div>':'<div class="alert alert-danger">Error</div>';
  };
</script>
{% include 'partials/footer.html' %}
</body>
</html>
