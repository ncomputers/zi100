<!-- Purpose: invite completion page -->
<!DOCTYPE html>
<html>
<head>
  <title>Complete Invite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/flatly/bootstrap.min.css" rel="stylesheet">
</head>
<body class="vms-body">
<div class="container mt-4">
  {% set company_logo = cfg.branding.company_logo_url or cfg.logo_url %}
  <div class="logo-wrapper mb-3 text-center">
    {% if company_logo %}
    <img src="{{ company_logo }}" alt="{{ cfg.branding.company_name }} logo" class="img-fluid" style="max-height:80px;">
    {% else %}
    <img src="/static/logo1.png" alt="Company logo" class="img-fluid" style="max-height:80px;">
    {% endif %}
  </div>
  <h2 class="mb-4 text-center">Complete Your Registration</h2>
  <form id="completeForm" class="row g-3">
    <div class="col-12">
      <label for="government_id" class="form-label">Government ID <span class="text-danger">*</span></label>
      <input id="government_id" class="form-control" name="government_id" required value="{{ invite.gov_id if invite else '' }}">
    </div>
    <div class="col-12">
      <label for="phone" class="form-label">Contact Number <span class="text-danger">*</span></label>
      <input id="phone" class="form-control" name="phone" value="{{ invite.phone if invite else '' }}">
    </div>
    <div class="col-12">
      <label for="purpose" class="form-label">Purpose <span class="text-danger">*</span></label>
      <input id="purpose" class="form-control" name="purpose" value="{{ invite.purpose if invite else '' }}">
    </div>
    <div class="col-12">
      <label for="vehicle" class="form-label">Vehicle Info</label>
      <input id="vehicle" class="form-control" name="vehicle" value="{{ invite.vehicle if invite and invite.vehicle else '' }}">
    </div>
    <div class="col-12">
      <label for="photo" class="form-label">Photo <span class="text-danger">*</span></label>
      <input type="file" id="photo" accept="image/*" class="form-control">
      <input type="hidden" name="photo" id="photoData">
    </div>
    <div class="col-12">
      <button class="btn btn-primary" type="submit">Submit</button>
    </div>
  </form>
  <div id="msg" class="mt-3"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const form = document.getElementById('completeForm');
  const id = JSON.parse('{{ invite_id|tojson }}');
  const storageKey = 'invite_complete_' + id;
  const stored = localStorage.getItem(storageKey);
  if(stored){
    try{
      const data = JSON.parse(stored);
      for(const k in data){
        const el = form.querySelector(`[name="${k}"]`);
        if(el){ el.value = data[k]; }
      }
    }catch(e){}
  }
  form.addEventListener('input', () => {
    const data = Object.fromEntries(new FormData(form).entries());
    localStorage.setItem(storageKey, JSON.stringify(data));
  });
  document.getElementById('photo').addEventListener('change', evt => {
    const file = evt.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('photoData').value = e.target.result;
      form.dispatchEvent(new Event('input'));
    };
    reader.readAsDataURL(file);
  });
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = new FormData(form);
    const r = await fetch(`/invite/complete/${id}`, {method:'POST', body:data});
    if(r.ok){
      localStorage.removeItem(storageKey);
      document.getElementById('msg').innerText = 'Registration complete.';
    } else {
      const d = await r.json();
      document.getElementById('msg').innerText = JSON.stringify(d);
    }
  });
})();
</script>
</body>
</html>

