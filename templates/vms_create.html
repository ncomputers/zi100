{% extends 'vms_base.html' %}
{% block title %}Create Gate Pass{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', path='css/gatepass.css') }}">
  <style>
    #previewCard img{object-fit:cover;}
    .iti{width:100%;}
  </style>
  <!-- Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.5/build/css/intlTelInput.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@tom-select/css/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
{% endblock %}
{% block content %}
  <!-- toast -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-primary border-0 fade-in" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <div class="container mt-4">
          <div class="row g-4">
            <!-- form -->
            <div class="col-lg-8">
        <form id="gateForm" data-default-host="{{ cfg.default_host or '' }}" data-print-base="/gatepass/print/" enctype="multipart/form-data">
          <ul class="nav nav-tabs" id="stepTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="visitor-tab" data-bs-toggle="tab" data-bs-target="#visitor" type="button" role="tab">Visitor</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="photo-tab" data-bs-toggle="tab" data-bs-target="#photo" type="button" role="tab">Photo</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="host-tab" data-bs-toggle="tab" data-bs-target="#host" type="button" role="tab">Host & Approval</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">Review</button>
            </li>
          </ul>
          <div class="tab-content pt-3">
            <!-- Tab 1 -->
            <div class="tab-pane fade show active fade-in" id="visitor" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="row g-3 two-column-form">
                    <div class="col-md-6">
                      <label for="inviteId" class="form-label font-small">Invitation ID</label>
                      <input type="text" class="form-control" id="inviteId">
                    </div>
                    <div class="col-md-6">
                      <label for="vName" class="form-label font-small">Name *</label>
                      <input type="text" class="form-control" id="vName" list="vNameList" required>
                      <datalist id="vNameList"></datalist>
                    </div>
                    <div class="col-md-6">
                      <label for="vPhone" class="form-label font-small">Phone *</label>
                      <input type="tel" class="form-control" id="vPhone" required>
                    </div>
                    <div class="col-md-6">
                      <label for="vEmail" class="form-label font-small">Email *</label>
                      <input type="email" class="form-control" id="vEmail" required>
                    </div>
                    <div class="col-md-6">
                      <label for="vType" class="form-label font-small">Visitor Type *</label>
                        <select id="vType" class="form-select" required>
                        <option value="">Select</option>
                        <option value="Official">Official</option>
                        <option value="Vendor">Vendor</option>
                        <option value="Guest">Guest</option>
                        <option value="Delivery">Delivery</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="vPurpose" class="form-label font-small">Purpose *</label>
                      <input type="text" class="form-control" id="vPurpose" required>
                    </div>
                    <div class="col-md-6">
                      <label for="vCompany" class="form-label font-small">Company</label>
                      <input type="text" class="form-control" id="vCompany">
                    </div>
                    <div class="col-md-6">
                      <label for="vValid" class="form-label font-small">Valid Until *</label>
                      <input type="datetime-local" class="form-control" id="vValid" required>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="toPhoto">Next</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- Tab 2 -->
            <div class="tab-pane fade fade-in" id="photo" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="mb-3">
                      {% with input_name='captured', input_id='captured', prefix='visitor' %}
                        {% include 'partials/photo_controls.html' %}
                      {% endwith %}
                    </div>
                    <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="backVisitor">Back</button>
                    <button type="button" class="btn btn-primary" id="toHost" disabled>Next</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- Tab 3 -->
            <div class="tab-pane fade fade-in" id="host" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="row g-3 two-column-form">
                    <div class="col-md-6 form-floating">
                      <input type="text" class="form-control" id="hName" placeholder=" " value="{{ cfg.default_host or '' }}" {% if not cfg.default_host %}required{% endif %}>
                      <label for="hName">Host{% if not cfg.default_host %} *{% endif %}</label>
                    </div>
                    <div class="col-md-6 form-floating">
                      <input type="text" class="form-control" id="hDept" placeholder=" ">
                      <label for="hDept">Department</label>
                    </div>
                  </div>
                  <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" id="needApproval">
                    <label class="form-check-label" for="needApproval">Needs Approval</label>
                  </div>
                  <div class="form-floating mt-2 d-none" id="approverBox">
                    <input type="email" class="form-control" id="approverEmail" placeholder=" ">
                    <label for="approverEmail">Approver Email</label>
                    <div class="invalid-feedback"></div>
                  </div>
                  <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="backPhoto">Back</button>
                    <button type="button" class="btn btn-primary" id="toReview">Next</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- Tab 4 -->
            <div class="tab-pane fade fade-in" id="review" role="tabpanel">
              <div class="card">
                <div class="card-body form-actions">
                  <button type="button" class="btn btn-secondary" id="backHost">Back</button>
                  <button type="button" class="btn btn-success" id="confirmBtn">Confirm and Save</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- preview card -->
      <div class="col-lg-4">
        <div id="previewCard" class="text-center">
          {% set preview_rec = {'name':'','phone':'','host':'','purpose':'','gate_id':'Draft','status':'Draft','valid_to_str':' '} %}
          {% with rec=preview_rec, branding=cfg.branding, status_color='secondary', show_card_signature=False %}
            {% include 'partials/gatepass_card.html' %}
          {% endwith %}
          <div class="mt-2 no-print">
            <button class="btn btn-secondary" id="printBtn" disabled>Print</button>
            <button class="btn btn-primary" id="pdfBtn" disabled>PDF</button>
            <button class="btn btn-success" id="viewBtn" disabled>Open Digital Pass</button>
            <button class="btn btn-info" id="shareBtn" disabled>Share</button>
            <button class="btn btn-outline-secondary d-none" id="copyPassLinkBtn">Copy Pass Link</button>
            <button class="btn btn-outline-secondary d-none" id="copyLinkBtn">Copy Approval Link</button>
            <button class="btn btn-outline-primary d-none" id="newBtn">New Gate Pass</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- preview modal -->
  <div class="modal fade slide-up" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Gate Pass</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div id="confirmCard" class="text-center">
            {% set preview_rec = {'name':'','phone':'','host':'','purpose':'','gate_id':'Draft','status':'Draft','valid_to_str':''} %}
            {% with rec=preview_rec, branding=cfg.branding, status_color='secondary', show_card_signature=False %}
              {% include 'partials/gatepass_card.html' %}
            {% endwith %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>
  <!-- post-save modal -->
  <div class="modal fade" id="postSaveModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gate Pass Created</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p>Gate Pass <span id="postGateId"></span> created successfully.</p>
        </div>
        <div class="modal-footer flex-wrap gap-2">
          <button type="button" class="btn btn-secondary" id="psPrintBtn">Print Pass</button>
          <button type="button" class="btn btn-success" id="psViewBtn">View Digital Pass</button>
          <button type="button" class="btn btn-primary" id="psPdfBtn">Download PDF</button>
          <div class="btn-group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">Share</button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" id="shareEmail" target="_blank">Email</a></li>
              <li><a class="dropdown-item" id="shareWhatsapp" target="_blank">WhatsApp</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tom-select/js/dist/js/tom-select.complete.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.5/build/js/intlTelInput.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script type="module">
    import { initGatepassForm } from "{{ url_for('static', path='js/gatepass_form.js') }}";
    document.addEventListener('DOMContentLoaded', () => {
      initGatepassForm();
    });
  </script>
{% endblock %}
