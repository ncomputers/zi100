{% extends 'vms_base.html' %}
{% block title %}Visitor Management{% endblock %}
{% block extra_head %}
  <script defer src="{{ url_for('static', path='js/chart.umd.min.js') }}"></script>
{% endblock %}
{% block content %}
      <h1 class="my-4">Visitor Management</h1>
      <div class="mb-3">
        <label class="form-label">Timeframe</label>
        <select id="timeframe" class="form-select w-auto d-inline-block ms-2" aria-label="Timeframe">
          <option value="today">Today</option>
          <option value="7d" selected>Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="this_month">This Month</option>
          <option value="this_year">This Year</option>
        </select>
      </div>
      <div id="statsLoading" class="text-center my-3 d-none">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
        <!-- Section: KPI Grid -->
        <div class="row row-cols-2 row-cols-lg-4 g-3 mb-4" id="statsRow">
          <div class="col">
            <div class="card kpi-card text-center py-3">
              <div class="fs-2 fw-bold" id="statOccupancy">0</div>
              <small class="text-muted">Current Occupancy</small>
            </div>
          </div>
          <div class="col">
            <div class="card kpi-card text-center py-3">
              <div class="fs-2 fw-bold" id="statPeak">-</div>
              <small class="text-muted">Visitor Peak Time</small>
            </div>
          </div>
          <div class="col">
            <div class="card kpi-card text-center py-3">
              <div class="fs-2 fw-bold" id="statInvites">0</div>
              <small class="text-muted">Total Invites Sent</small>
            </div>
          </div>
          <div class="col">
            <div class="card kpi-card text-center py-3">
              <div class="fs-2 fw-bold" id="statDay">-</div>
              <small class="text-muted">Busiest Day</small>
            </div>
          </div>
        </div>
        <!-- Section: Charts -->
        <div class="row g-3 mb-4">
          <div class="col-lg-6">
            <div class="card chart-card h-100"><div class="card-body p-2">
              <canvas id="dailyChart"></canvas>
            </div></div>
          </div>
          <div class="col-lg-6">
            <div class="card chart-card h-100"><div class="card-body p-2">
              <canvas id="employeeChart"></canvas>
            </div></div>
          </div>
          <div class="col-lg-6">
            <div class="card chart-card h-100"><div class="card-body p-2">
              <canvas id="visitorChart"></canvas>
            </div></div>
          </div>
          <div class="col-lg-6">
            <div class="card chart-card h-100"><div class="card-body p-2">
              <canvas id="purposeChart"></canvas>
            </div></div>
          </div>
        </div>
      <div id="alertBox"></div>
        <!-- Section: Table -->
        <div id="recentVisitorsSection">
          <h3 class="mt-4">Recent Visitors</h3>
          <div id="recentVisitorsLoader" class="text-center my-3 d-none">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div class="table-responsive"><table class="table" id="logTable">
            <thead><tr><th>Photo</th><th>Gate Pass</th><th>Name</th><th>Phone</th><th>Host</th><th>Type</th><th>Purpose</th><th>Time</th><th>Valid To</th></tr></thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <td>{% if r.image %}<img src="data:image/jpeg;base64,{{ r.image }}" class="recent-photo" alt="visitor">{% endif %}</td>
                <td>{{ r.gate_id }}</td><td>{{ r.name }}</td><td>{{ r.phone }}</td><td>{{ r.host }}</td><td>{{ r.visitor_type }}</td><td>{{ r.purpose }}</td><td>{{ r.time }}</td><td>{{ r.valid_to_str|default('') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table></div>
        </div>
{% endblock %}
{% block extra_scripts %}
<script>
window.addEventListener('DOMContentLoaded', () => {
const nav=document.getElementById('mainNav');
let lastScroll=0;
window.addEventListener('scroll',()=>{
  const cur=window.pageYOffset;
  if(cur>lastScroll && cur>100){
    nav.classList.add('nav-hidden');
  }else{
    nav.classList.remove('nav-hidden');
  }
  lastScroll=cur;
});

function renderCharts(d){
  new Chart(document.getElementById('dailyChart'),{
    type:'line',
    data:{labels:d.visitor_daily.map(x=>x.date),datasets:[{label:'Visits',data:d.visitor_daily.map(x=>x.count),borderColor:'#007bff',fill:false}]},
    options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
  new Chart(document.getElementById('employeeChart'),{
    type:'bar',
    data:{labels:d.top_employees.map(x=>x.name),datasets:[{label:'Visitors',data:d.top_employees.map(x=>x.count),backgroundColor:'#28a745'}]},
    options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
  });
  new Chart(document.getElementById('visitorChart'),{
    type:'doughnut',
    data:{labels:d.top_visitors.map(x=>x.name),datasets:[{data:d.top_visitors.map(x=>x.count),backgroundColor:['#6f42c1','#ffc107','#17a2b8','#dc3545','#fd7e14']}]},
    options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}
  });
  new Chart(document.getElementById('purposeChart'),{
    type:'doughnut',
    data:{labels:d.purpose_counts.map(x=>x.name),datasets:[{data:d.purpose_counts.map(x=>x.count),backgroundColor:['#0d6efd','#20c997','#ffc107','#dc3545','#6f42c1']}]},
    options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}
  });
}

async function loadStats(){
  const tf=document.getElementById('timeframe').value;
  const loader=document.getElementById('statsLoading');
  loader.classList.remove('d-none');
  const r=await fetch('/vms/stats?range='+encodeURIComponent(tf));
  loader.classList.add('d-none');
  if(!r.ok) return;
  const d=await r.json();
  document.getElementById('statOccupancy').innerText=d.occupancy;
  document.getElementById('statPeak').innerText=d.peak_hour;
  document.getElementById('statInvites').innerText=d.total_invites;
  document.getElementById('statDay').innerText=d.busiest_day;
  renderCharts(d);
}

document.getElementById('timeframe').addEventListener('change',loadStats);

const statsSection=document.getElementById('statsRow');
if('IntersectionObserver' in window){
  const obs=new IntersectionObserver(entries=>{
    if(entries.some(e=>e.isIntersecting)){
      loadStats();
      obs.disconnect();
    }
  });
  obs.observe(statsSection);
}else{
  window.addEventListener('load',loadStats);
}
const recentLoader=document.getElementById('recentVisitorsLoader');
async function loadRecentVisitors(){
  recentLoader.classList.remove('d-none');
  const resp=await fetch('/vms/recent');
  recentLoader.classList.add('d-none');
  if(resp.ok){
    const rows=await resp.json();
    const tbody=document.querySelector('#logTable tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const img=r.image?`<img src="data:image/jpeg;base64,${r.image}" class="recent-photo" alt="visitor">`:'';
      tr.innerHTML=`<td>${img}</td><td>${r.gate_id}</td><td>${r.name}</td><td>${r.phone}</td><td>${r.host}</td><td>${r.visitor_type}</td><td>${r.purpose}</td><td>${r.time}</td><td>${r.valid_to_str||''}</td>`;
      tbody.appendChild(tr);
    });
  }
}
  loadRecentVisitors();
});
</script>
{% endblock %}
